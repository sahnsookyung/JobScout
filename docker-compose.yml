services:
  jobspy-service:
    # Job Fetching API Service
    image: sahnsookyung/jobspy:1.0.1
    platform: linux/amd64 # only linux/amd64 version exists for now.
    ports:
      - "8000:8000"

  # Redis for async notification queue
  redis:
    image: redis:7-alpine
    container_name: jobscout-redis
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # Postgres with pgvector
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: jobscout
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # This is your Main Driver container (renamed context, kept service name for now)
  main-driver:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - jobspy-service
      - postgres
      - redis
    env_file:
      - .env
    environment:
      # These override .env values for Docker networking
      - JOBSPY_URL=http://jobspy-service:8000
      - DATABASE_URL=postgresql://user:password@postgres:5432/jobscout
      - REDIS_URL=redis://redis:6379/0
      # Default to local host Ollama
      - ETL_LLM_BASE_URL=${ETL_LLM_BASE_URL:-http://host.docker.internal:11434/v1}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./api_responses.json:/app/api_responses.json # Mount for testing
      - ./config.yaml:/app/config.yaml
      - ./main.py:/app/main.py:ro # Only mount specific files for live reload
      - ./core:/app/core:ro
      - ./database:/app/database:ro
      - ./etl:/app/etl:ro

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: user@example.com
      PGADMIN_DEFAULT_PASSWORD: password
    ports:
      - "5050:80"
    depends_on:
      - postgres
  # Ollama for local embeddings
  # Ollama for local embeddings (Optional Profile)
  # Run with: docker compose --profile docker-ollama up
  ollama:
    image: ollama/ollama:${OLLAMA_IMAGE:-0.15.2}
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL:-qwen3-embedding:4b}
      - OLLAMA_EXTRACTION_MODEL=${OLLAMA_EXTRACTION_MODEL:-qwen3:14b}
    volumes:
      - ollama_models:/root/.ollama
      - ./scripts:/scripts:ro
    entrypoint: [ "/bin/bash", "/scripts/ollama-entrypoint.sh" ]
    healthcheck:
      test: [ "CMD", "ollama", "list" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - docker-ollama
      - expose # Optional port exposure

volumes:
  postgres_data:
  redis_data:
  ollama_models:
